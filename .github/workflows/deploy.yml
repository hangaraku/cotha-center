name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Remote Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql, gd
          coverage: none
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install NPM dependencies
        run: npm ci
          
      - name: Build assets
        run: npm run build
          
      - name: Create deployment archive
        run: |
          mkdir -p deployment
          rsync -av --exclude='node_modules' \
                    --exclude='vendor' \
                    --exclude='.git' \
                    --exclude='.github' \
                    --exclude='deployment' \
                    --exclude='tests' \
                    --exclude='.env' \
                    --exclude='storage/logs/*' \
                    --exclude='storage/framework/cache/*' \
                    --exclude='storage/framework/sessions/*' \
                    --exclude='storage/framework/views/*' \
                    . deployment/
          tar -czf deployment.tar.gz -C deployment .
          
      - name: Deploy to Remote Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            
            # Navigate to project directory
            cd /home/comfypace/htdocs/comfypace.com
            
            # Check PHP version
            echo "Checking PHP version..."
            PHP_VERSION=$(php -r "echo PHP_VERSION;")
            echo "Server PHP version: $PHP_VERSION"
            
            # Create backup
            echo "Creating backup..."
            BACKUP_DIR="/home/comfypace/backups"
            mkdir -p $BACKUP_DIR
            BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf $BACKUP_FILE --exclude='node_modules' --exclude='vendor' .
            
            # Keep only last 5 backups
            ls -t $BACKUP_DIR/backup-*.tar.gz | tail -n +6 | xargs -r rm
            
            # Enable maintenance mode
            echo "Enabling maintenance mode..."
            php artisan down --retry=60 || true
            
            # Update git remote if needed
            echo "Updating git remote..."
            git remote remove origin || true
            git remote add origin https://github.com/${{ github.repository }}.git
            
            # Pull latest changes
            echo "Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main
            
            # Install/Update Composer dependencies
            echo "Installing Composer dependencies..."
            composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction
            
            # Install/Update NPM dependencies and build
            echo "Building assets..."
            npm ci
            npm run build
            
            # Clear and optimize Laravel
            echo "Optimizing Laravel..."
            php artisan config:clear
            php artisan cache:clear
            php artisan view:clear
            php artisan route:clear
            
            # Run migrations
            echo "Running migrations..."
            php artisan migrate --force
            
            # Optimize for production
            echo "Optimizing application..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Set correct permissions
            echo "Setting permissions..."
            chmod -R 755 storage bootstrap/cache
            chown -R www-data:www-data storage bootstrap/cache
            
            # Disable maintenance mode
            echo "Disabling maintenance mode..."
            php artisan up
            
            echo "Deployment completed successfully!"
            
      - name: Upload deployment artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-archive
          path: deployment.tar.gz
          retention-days: 7
          
      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi
